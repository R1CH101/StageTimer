<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Master Timer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #222;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background-color 0.5s;
        }

        /* DYNAMIC BACKGROUNDS */
        body.green { background-color: #27ae60; }
        body.amber { background-color: #f39c12; }
        body.red { background-color: #c0392b; }
        body.flash { animation: blinking 0.5s infinite; background-color: #c0392b; }
        body.blackout { background-color: #000 !important; color: #333 !important; }

        @keyframes blinking {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* LARGE DISPLAY */
        #timer-text {
            font-size: 25vw;
            font-weight: bold;
            line-height: 1;
        }

        #message-text {
            font-size: 4vw;
            margin-top: 10px;
            font-weight: 300;
        }

        /* CONTROL PANEL (Hidden by default, swipe/hover to see) */
        #controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 20px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
            transform: translateY(92%); /* Peeking out */
            transition: transform 0.3s;
            z-index: 100;
        }
        #controls:hover, #controls.active { transform: translateY(0); }

        .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;}
        button {
            padding: 12px 18px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #e0e0e0;
            flex: 1;
        }
        button.primary { background: #3498db; color: white; }
        button.danger { background: #e74c3c; color: white; }
        button.connect { background: #2c3e50; color: white; font-weight: bold; }
        
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 60px; }
        label { font-size: 12px; font-weight: bold; color: #555; }
    </style>
</head>
<body class="green">

    <div id="timer-text">--:--</div>
    <div id="message-text">Not Connected</div>

    <div id="controls">
        <div class="row" style="border-bottom: 1px solid #ddd; padding-bottom: 10px;">
            <button class="connect" onclick="connectToESP32()">ðŸ“¡ Connect to ESP32</button>
            <button onclick="toggleControls()">Toggle Panel</button>
        </div>

        <div class="row">
            <button onclick="sendTime(5)">5 Min</button>
            <button onclick="sendTime(10)">10 Min</button>
            <button onclick="sendTime(15)">15 Min</button>
            <button onclick="sendTime(20)">20 Min</button>
        </div>

        <div class="row">
             <input type="number" id="custom-min" placeholder="Min" value="30">
             <button onclick="sendTime(document.getElementById('custom-min').value)">Set Custom</button>
        </div>

        <div class="row">
            <button class="primary" onclick="sendCommand('START')">Resume</button>
            <button class="primary" onclick="sendCommand('PAUSE')">Pause</button>
            <button class="danger" onclick="sendCommand('RESET')">Reset</button>
        </div>

        <div class="row">
            <div>
                <label>Amber (min):</label>
                <input type="number" id="amber-cfg" value="2">
            </div>
            <div>
                <label>Red (min):</label>
                <input type="number" id="red-cfg" value="0">
            </div>
            <button onclick="sendConfig()">Update Colors</button>
        </div>

        <div class="row" style="margin-top: 20px; border-top: 1px solid #ccc; padding-top:10px;">
            <label style="width:100%;">LOCAL OVERRIDES (Does not affect ESP32)</label>
            <button onclick="document.body.classList.toggle('blackout')">Show/Hide Screen</button>
            <button onclick="document.getElementById('message-text').innerText = prompt('Set Message:')">Set Message</button>
        </div>
    </div>

    <script>
        // --- BLUETOOTH CONFIG ---
        const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb"; 
        const CHAR_UUID = "0000ffe1-0000-1000-8000-00805f9b34fb";

        let bleDevice, bleCharacteristic;

        async function connectToESP32() {
            try {
                document.getElementById('message-text').innerText = "Scanning...";
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0xFFE0] }], // Standard HM-10 / ESP32 UUID
                    optionalServices: [SERVICE_UUID]
                });

                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleCharacteristic = await service.getCharacteristic(CHAR_UUID);

                // Listen for updates from ESP32
                await bleCharacteristic.startNotifications();
                bleCharacteristic.addEventListener('characteristicvaluechanged', handleUpdate);

                document.getElementById('message-text').innerText = "Connected";
                
                // On connect, push the current color config
                sendConfig();

            } catch (error) {
                console.error(error);
                document.getElementById('message-text').innerText = "Connection Failed";
            }
        }

        // --- HANDLE DATA FROM ESP32 ---
        function handleUpdate(event) {
            const value = new TextDecoder().decode(event.target.value);
            // Expected format: "TIME:MM:SS|color"
            console.log("ESP32 says:", value);

            if (value.startsWith("TIME:")) {
                const parts = value.split('|');
                const timeStr = parts[0].substring(5); // Remove 'TIME:'
                const colorStr = parts[1];

                document.getElementById('timer-text').innerText = timeStr;
                
                // Update background color based on ESP32 decision
                document.body.className = colorStr; 
            }
        }

        // --- SEND COMMANDS TO ESP32 ---
        async function sendCommand(cmd) {
            if (!bleCharacteristic) return;
            const encoder = new TextEncoder();
            await bleCharacteristic.writeValue(encoder.encode(cmd));
        }

        async function sendTime(minutes) {
            const seconds = minutes * 60;
            await sendCommand("SET:" + seconds);
        }

        async function sendConfig() {
            const amber = parseInt(document.getElementById('amber-cfg').value) * 60;
            const red = parseInt(document.getElementById('red-cfg').value) * 60;
            // Format: CFG:amberSec,redSec
            await sendCommand(`CFG:${amber},${red}`);
        }

        function toggleControls() {
            document.getElementById('controls').classList.toggle('active');
        }
    </script>
</body>
</html>
