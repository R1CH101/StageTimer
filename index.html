<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Timer</title>
    <!-- Use Google Poppins to better mirror device Poppins VLW appearance -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #fff; --accent: #3b82f6; --danger: #ef4444; --warn: #eab308; --success: #22c55e; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 20px;}

        /* Preview */
        #preview-container { width: 100%; height: 160px; background: #000; display: flex; flex-direction:column; align-items: center; justify-content: center; border-bottom: 2px solid #333; position: sticky; top:0; z-index:10; }
        /* Device-mock preview to resemble the real display (aspect ratio, font, scrolling) */
        .device-mock { width: 100%; max-width:420px; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; aspect-ratio: 4 / 3; padding:0; box-sizing:border-box; max-height:30vh; }
        .device-mock .screen { width: 92%; height: 92%; max-width: 100%; background: #000; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; padding-bottom:12%; position:relative; aspect-ratio: 4 / 3; box-sizing:border-box; border-radius:6px; overflow:hidden; }
        /* Timer should match device: large, centered, ~70% width */
        #p-time { font-family: 'Poppins', system-ui, sans-serif; font-size: clamp(64px, 20vw, 220px); font-weight: 400; line-height: 1; margin:0; transition: color 0.12s; text-align:center; display:flex; align-items:center; justify-content:center; white-space:nowrap; overflow:hidden; font-variant-numeric: tabular-nums; -webkit-font-feature-settings: "tnum" 1; font-feature-settings: "tnum" 1; letter-spacing: -0.02em; }
        /* Messages match device size and sit at the bottom centered (match FS font) */
        #p-msg { position:absolute; bottom:6%; left:0; width:100%; display:flex; justify-content:center; align-items:center; font-family: 'Poppins', system-ui, sans-serif; font-size: 28px; font-weight:700; text-align: center; overflow:hidden; white-space:nowrap; }
        .screen.msg-active { justify-content: center; }
        .screen.msg-active #p-time { transform: translateY(-12%); }
        /* Center full-screen messages vertically within the screen */
        .screen.msg-active #p-msg { top:50%; bottom:auto; transform: translateY(-50%); }
        #p-time { transition: transform 160ms ease; }
        /* Scrolling inner span */
        #p-msg > span { display: inline-block; white-space:nowrap; }
        .timer-bar { position:absolute; left:0; right:0; bottom:0; height:3%; background: rgba(255,255,255,0.04); }
        .timer-bar-fill { height:100%; width:0%; background: linear-gradient(90deg, #ffffff 0%, #ffffff 100%); }
        .timer-bar-fill { height:100%; width:0%; background: linear-gradient(90deg, #ffffff 0%, #ffffff 100%); }
        .status-bar.off { color: var(--danger); font-weight: bold; background: #300; }

        /* Layout */
        .container { padding: 8px; display: flex; flex-direction: column; gap: 10px; }
        .panel { background: var(--panel); border-radius: 8px; padding: 10px; }
        h3 { margin: 0 0 8px 0; color: #888; font-size: 0.78rem; text-transform: uppercase; }

        .row { display: flex; gap: 6px; margin-bottom: 8px; align-items: center; }
        /* Special rows that must stay horizontal even on narrow screens */
        .preset-row, .controls-row, .custom-row { flex-direction: row; flex-wrap: nowrap; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }

        button { border: none; padding: 10px 6px; border-radius: 6px; font-weight: bold; font-size: 0.95rem; cursor: pointer; background: #333; color: white; width:100%; }
        button:active { transform: scale(0.98); }
        .btn-green { background: var(--success); color: #000; }
        .btn-red { background: var(--danger); }
        .btn-warn { background: var(--warn); color: #000; }
        .btn-blue { background: var(--accent); }

        input { background: #2a2a2a; border: 1px solid #444; color: white; padding: 8px; border-radius: 6px; width: 100%; box-sizing: border-box; font-size:0.95rem; }

        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        input[type="checkbox"] { width: 20px; height: 20px; }

        .mode-toggle { display:flex; justify-content:center; gap:10px; background:#000; padding:6px; border-radius:6px; margin-bottom:10px; }
        .mode-opt { color:#666; font-weight:bold; cursor:pointer; }
        .mode-opt.active { color:var(--accent); text-decoration: underline; }

        .color-row { display:none; gap:5px; margin-top:8px; }
        .c-btn { flex:1; height:34px; border-radius:6px; border:1px solid #333; cursor:pointer; opacity:0.85; }
        .c-btn.selected { border-color:white; opacity:1; box-shadow:0 0 4px rgba(255,255,255,0.06); }
        .bg-auto { background: #333; text-align:center; line-height:32px; font-size:0.82rem; color:#aaa; }
        .bg-grn { background: var(--success); }
        .bg-amb { background: var(--warn); }
        .bg-red { background: var(--danger); }
        .bg-blk { background: #000; }

        /* Compact safe toggle */
        .safe-toggle { display:flex; gap:6px; margin-bottom:8px; }
        .safe-opt { flex:1; padding:6px; text-align:center; background:#333; cursor:pointer; border-radius:4px; font-size:0.85rem; }
        .safe-opt.selected { border:1px solid #fff; font-weight:bold; }

        /* Hide only labels explicitly marked as hidden; keep important labels visible */
        .hide-label { display:none; }
        label { display:inline-block; font-size:0.9rem; color:#ccc; margin:0; }

        /* Responsive tweaks */
        @media (max-width: 700px) {
            #preview-container { height: auto; padding:6px; }
            .device-mock { aspect-ratio: 4 / 3; }
            #p-time { font-size: 2rem; }
            #p-msg { font-size: 0.95rem; }
            .grid-4 { grid-template-columns: repeat(2, 1fr); gap:6px; }
            .row:not(.preset-row):not(.controls-row):not(.custom-row), .toggle-row { flex-direction: column; gap:6px; align-items: stretch; }
            .row > button, .grid-4 button, button { width: 100%; padding:8px 6px; font-size:0.95rem; }
            .container { padding: 8px; }
            .panel { padding:8px; }
            h3 { font-size:0.72rem; }
            input, select { padding:8px; font-size:0.95rem; }
            .status-bar { font-size:0.72rem; padding:4px 0; }
            #preview-container { border-bottom-width:2px; }
        }

        @media (max-width: 400px) {
            #preview-container { height:80px; }
            #p-time { font-size:1.6rem; }
            .grid-4 { grid-template-columns: 1fr; }
            .row, .toggle-row { gap:4px; }
            button { padding:7px 6px; font-size:0.9rem; }
            .panel { padding:6px; }
        }

    </style>
</head>
<body>

    <div id="preview-container">
        <div class="device-mock">
            <div class="screen" id="screen">
                <div id="p-time">--:--</div>
                <div id="p-msg"><span></span></div>
                <div class="timer-bar" id="timer-bar"><div class="timer-bar-fill" id="timer-fill"></div></div>
            </div>
        </div>
    </div>
    <div class="status-bar" id="status">Tap Connect</div>
    <button onclick="connectBLE()" id="btn-conn" class="btn-blue" style="border-radius:0">CONNECT</button>

    <div class="container">
        
        <div class="panel">
            <h3>Set Time (Target)</h3>
            <div class="row">
                <div class="row custom-row">
                    <div style="flex:1"><label class="hide-label">Min</label><input type="number" id="cust-min" value="0"></div>
                    <div style="flex:1"><label class="hide-label">Sec</label><input type="number" id="cust-sec" value="0"></div>
                </div>
                
                    <div class="row preset-row" style="margin-top:10px">
                        <button style="flex:1" onclick="setPreset(5)">5m</button>
                        <button style="flex:1" onclick="setPreset(10)">10m</button>
                        <button style="flex:1" onclick="setPreset(15)">15m</button>
                        <button style="flex:1" onclick="setPreset(20)">20m</button>
                    </div>
            </div>
            <div class="row controls-row" style="margin-top:15px">
                <button class="btn-green" style="flex:1" onclick="sendCmd('START')">START</button>
                <button class="btn-red" style="flex:1" onclick="sendCmd('STOP')">STOP</button>
                <button class="btn-warn" style="flex:1" onclick="sendCmd('RESET')">RESET</button>
            </div>
        </div>

        <div class="panel">
            <h3>Message Center</h3>
            <input type="text" id="msg-text" maxlength="120" placeholder="Enter message (Max 120)" style="font-size:1.1rem; margin-bottom:15px">
            
            <div class="row" style="align-items:center; gap:8px;">
                <div style="display:flex; align-items:center; gap:6px;">
                    <span style="font-size:0.9rem; color:#ccc">Duration (s)</span>
                    <input type="number" id="msg-dur" value="30" style="width:60px; text-align:center">
                </div>
                <div style="display:flex; align-items:center; gap:6px;">
                    <label style="font-size:0.9rem; color:#ccc; margin:0">Full Screen</label>
                    <input type="checkbox" id="chk-fs" onchange="toggleColorRow()">
                </div>
                <div style="display:flex; align-items:center; gap:6px;">
                    <label style="font-size:0.9rem; color:#ccc; margin:0">Flash</label>
                    <input type="checkbox" id="chk-fl">
                </div>
            </div>
            <div class="color-row" id="color-picker-row">
                <div class="c-btn bg-auto selected" onclick="setMsgColor(-1, this)">Auto</div>
                <div class="c-btn bg-amb" onclick="setMsgColor(1, this)"></div>
                <div class="c-btn bg-red" onclick="setMsgColor(2, this)"></div>
                <div class="c-btn bg-blk" onclick="setMsgColor(3, this)"></div>
            </div>

            <div class="row" style="margin-top:10px">
                <button class="btn-blue" onclick="sendMessage()">SEND</button>
                <button style="background:#444" onclick="sendCmd('CLR')">CLEAR</button>
            </div>
        </div>

        <div class="panel">
            <h3>Device Settings</h3>
            <div class="row">
                <div style="flex:1"></div>
            </div>
            <!-- Direct Draw forced on; control removed -->
            <!-- touch controls removed -->
            
        </div>

        <div class="panel">
            <h3>Auto-Alert Defaults</h3>
            <div style="font-size:0.86rem; color:#bbb; margin-bottom:8px">
                <strong style="color:var(--warn)">Amber alert:</strong> Trigger at the specified minutes remaining before the end and show the Amber Text when triggered.<br>
                <strong style="color:var(--danger)">Red alert:</strong> Trigger at the specified minutes remaining before the end and show the Red Text when triggered.
            </div>
            <div class="row">
                <div style="flex:1">
                    <label style="color:var(--warn)">Amber Min</label>
                    <input type="number" id="def-amber-t" value="2" onchange="saveDef()">
                </div>
                <div style="flex:2">
                    <label>Amber Text</label>
                    <input type="text" id="def-amber-msg" value="Prepare to finish" onchange="saveDef()">
                </div>
            </div>
            <div class="row">
                <div style="flex:1">
                    <label style="color:var(--danger)">Red Min</label>
                    <input type="number" id="def-red-t" value="0" onchange="saveDef()">
                </div>
                <div style="flex:2">
                    <label>Red Text</label>
                    <input type="text" id="def-red-msg" value="Please Close!" onchange="saveDef()">
                </div>
            </div>
        </div>
    </div>

    <script>
        const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const CHAR_UUID = "0000ffe1-0000-1000-8000-00805f9b34fb";
        let bluetoothDevice;
        let char;
        const pTimeEl = document.getElementById('p-time');
        const pMsgEl = document.getElementById('p-msg');
        const pMsgInner = pMsgEl.querySelector('span');
        const timerFill = document.getElementById('timer-fill');
        const timerBar = document.getElementById('timer-bar');
        const deviceMock = document.querySelector('.device-mock');
        
        let currentSec = 0;
        let totalSec = 0; 
        let isRunning = false;
        let amberTriggered = false;
        let redTriggered = false;
        let selectedMsgColor = -1;

        // Fit the timer text so it occupies most of the preview width (â‰ˆ92%).
        function fitTimerToWidth() {
            if (!pTimeEl || !deviceMock) return;
            const screenEl = document.getElementById('screen');
            const baseWidth = (screenEl && screenEl.clientWidth) ? screenEl.clientWidth : deviceMock.clientWidth;
            const avail = baseWidth * 0.7; // target width (~70%)
            const text = pTimeEl.innerText || '--:--';
            // binary search for best font-size
            let lo = 8, hi = 800, best = lo;
            const measEl = pTimeEl;
            // ensure monospace-like measurement: remove padding while measuring
            const prevPadding = measEl.style.padding;
            measEl.style.padding = '0';
            while (lo <= hi) {
                const mid = Math.floor((lo + hi) / 2);
                measEl.style.fontSize = mid + 'px';
                // force reflow measurement
                const w = measEl.getBoundingClientRect().width;
                if (w <= avail) { best = mid; lo = mid + 1; }
                else { hi = mid - 1; }
            }
            measEl.style.fontSize = best + 'px';
            measEl.style.padding = prevPadding;
        }

        window.addEventListener('resize', () => { fitTimerToWidth(); });

        function toggleColorRow() {
            const fs = document.getElementById('chk-fs').checked;
            document.getElementById('color-picker-row').style.display = fs ? 'flex' : 'none';
        }

        function setMsgColor(c, el) {
            selectedMsgColor = c;
            document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        function saveDef() {
            syncCfg();
        }

        async function connectBLE() {
            try {
                bluetoothDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnect);
                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                char = await service.getCharacteristic(CHAR_UUID);
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', onData);
                
                document.getElementById('status').innerText = "Connected";
                document.getElementById('status').classList.remove('off');
                document.getElementById('status').style.color = "#22c55e";
                document.getElementById('btn-conn').style.display = 'none';
                // Fit timer once after connecting so font-size is stable (avoid resizing each tick)
                fitTimerToWidth();
                
                // Fetch current config from device
                setTimeout(() => { sendCmd("GET_CFG"); }, 500);
                setTimeout(() => { syncTime(); }, 1000);

            } catch(e) { alert("Connection failed: " + e); }
        }

        function syncTime() {
            const now = new Date();
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            const s = now.getSeconds().toString().padStart(2, '0');
            sendCmd(`TIME:${h}:${m}:${s}`);
        }

        function onDisconnect() {
            document.getElementById('status').innerText = "DISCONNECTED";
            document.getElementById('status').classList.add('off');
            document.getElementById('btn-conn').style.display = 'block';
            document.getElementById('preview-container').style.background = "#000";
            const screenEl = document.getElementById('screen'); if (screenEl) screenEl.style.background = '#000';
            document.getElementById('p-time').innerText = "--:--";
            char = null;
        }

        function onData(e) {
            const dec = new TextDecoder();
            const raw = dec.decode(e.target.value); 
            const p = raw.split('|');

            // Handle Config Sync from Device
            if (p[0] === "CFG_DATA") {
                // CFG_DATA|totalSec|at|rt|bright|am|rm
                totalSec = parseInt(p[1]);
                document.getElementById('cust-min').value = Math.floor(totalSec / 60);
                document.getElementById('cust-sec').value = totalSec % 60;
                
                document.getElementById('def-amber-t').value = Math.floor(parseInt(p[2]) / 60);
                document.getElementById('def-red-t').value = Math.floor(parseInt(p[3]) / 60);
                // Adjust timer sizing now that we know device config
                fitTimerToWidth();
                
                document.getElementById('def-amber-msg').value = p[5] || "";
                document.getElementById('def-red-msg').value = p[6] || "";
                // Direct Draw is forced on in device firmware
                return;
            }

            // Packet: TIME|BG|TXT|MSG|IS_FS
            if(p.length >= 5) {
                // Keep outer preview container black (letterbox); set inner screen color to device bg
                const screenEl = document.getElementById('screen');
                if (screenEl) screenEl.style.background = p[1];
                const timeEl = document.getElementById('p-time');
                const msgEl = document.getElementById('p-msg');
                const isFs = (p[4] === "1");

                // Use inner span for scrolling measurement/animation
                const newMsg = p[3] || "";
                if (isFs) {
                    // Full-screen: hide timer and render multiline message (no scrolling)
                    timeEl.style.display = 'none';
                    stopScroller();
                    // enable wrapping, center-align and allow the span to be block-level for proper multiline layout
                    pMsgInner.style.whiteSpace = 'normal';
                    pMsgInner.style.display = 'block';
                    pMsgInner.style.width = '86%';
                    pMsgInner.style.wordBreak = 'break-word';
                    pMsgInner.style.textAlign = 'center';
                    // use innerHTML so incoming explicit newlines are preserved as <br>
                    pMsgInner.innerHTML = (newMsg + '').replace(/\n/g, '<br>');
                    msgEl.style.fontSize = '28px';
                    msgEl.style.fontWeight = '700';
                    msgEl.style.height = 'auto';
                    // center lines vertically/horizontally
                    pMsgEl.style.justifyContent = 'center';
                    pMsgEl.style.alignItems = 'center';
                } else {
                    timeEl.style.display = 'block';
                    timeEl.style.color = p[2];
                    timeEl.innerText = p[0];
                    // Use same font as full-screen message (size/weight) but keep it at bottom under timer
                    msgEl.style.fontSize = '28px';
                    msgEl.style.fontWeight = '700';
                    msgEl.style.height = 'auto';
                    pMsgInner.style.whiteSpace = 'nowrap';
                    // restore inline-block for smooth scrolling
                    pMsgInner.style.display = 'inline-block';
                    pMsgInner.style.width = 'auto';
                    pMsgInner.style.wordBreak = 'normal';
                }

                msgEl.style.color = p[2];
                        // Update timer bar based on current/total seconds
                // totalSec is set from CFG_DATA earlier; guard divide by zero
                if (totalSec > 0) {
                    const timeParts = p[0].replace('-','').split(':');
                    if (timeParts.length === 2) {
                        const sec = (parseInt(timeParts[0]) * 60) + parseInt(timeParts[1]);
                        const pct = Math.max(0, Math.min(100, Math.round((sec / totalSec) * 100)));
                        timerFill.style.width = pct + '%';
                        // set fill color to text color so it mirrors device
                        timerFill.style.background = p[2];
                    }
                }
                // Update message text and start scrolling only when message changed
                // Do not overwrite full-screen HTML (we already set innerHTML above)
                if (!isFs) {
                    if (pMsgInner.innerText !== newMsg) {
                        pMsgInner.innerText = newMsg;
                        setupScrollingIfNeeded();
                    }
                }

                // Hide timer bar when a message is active or when full-screen message
                if (newMsg && newMsg.length > 0 || isFs) {
                    if (timerBar) timerBar.style.display = 'none';
                } else {
                    if (timerBar) timerBar.style.display = 'block';
                }

                // Toggle screen msg-active class to shift timer up when message shown
                if (screenEl) {
                    if (newMsg && newMsg.length > 0 || isFs) screenEl.classList.add('msg-active');
                    else screenEl.classList.remove('msg-active');
                }
                
                let timeParts = p[0].replace('-','').split(':');
                if(timeParts.length === 2) {
                    let sec = (parseInt(timeParts[0])*60) + parseInt(timeParts[1]);
                    if(p[0].includes('-')) sec = -sec;
                    currentSec = sec;
                    checkAutoAlerts(p[3]); 
                }
            }
        }

        // Scrolling implementation mirroring device speed (~60px/s)
        let scrollState = { enabled: false, pos: 0, width: 0, containerWidth: 0, lastTs: 0 };
        function setupScrollingIfNeeded() {
            const txt = pMsgInner.innerText || '';
            // reset
            scrollState.lastTs = performance.now();
            // Measure widths
            pMsgInner.style.transition = 'none';
            pMsgInner.style.transform = 'translateX(0px)';
            const spanWidth = pMsgInner.getBoundingClientRect().width;
            const contWidth = pMsgEl.getBoundingClientRect().width;
            scrollState.width = spanWidth; scrollState.containerWidth = contWidth;
            if (spanWidth > contWidth) {
                // start with text off-screen to the right like device
                scrollState.enabled = true; scrollState.pos = contWidth; startScroller();
            } else {
                scrollState.enabled = false; pMsgInner.style.transform = 'translateX(0px)'; stopScroller();
            }
        }

        let scrollerRAF = null;
        function startScroller() {
            if (scrollerRAF) return;
            scrollState.lastTs = performance.now();
            function step(ts) {
                const dt = (ts - scrollState.lastTs) / 1000.0;
                scrollState.lastTs = ts;
                const speed = 60; // pixels per second, match device
                scrollState.pos -= speed * dt;
                if (-scrollState.pos > scrollState.width) {
                    // reset to start after a short pause
                    scrollState.pos = scrollState.containerWidth;
                }
                pMsgInner.style.transform = `translateX(${Math.floor(scrollState.pos)}px)`;
                scrollerRAF = requestAnimationFrame(step);
            }
            scrollerRAF = requestAnimationFrame(step);
        }
        function stopScroller() { if (scrollerRAF) { cancelAnimationFrame(scrollerRAF); scrollerRAF = null; } }

        async function sendCmd(c) {
            if(!char) return;
            try {
                const enc = new TextEncoder().encode(c);
                await char.writeValue(enc);
                if(c === "RESET" || c.startsWith("SET")) {
                    amberTriggered = false; redTriggered = false; isRunning = false;
                }
                if(c === "START") isRunning = true;
            } catch(e) { console.log("Send Error"); }
        }

        function setPreset(min) { 
            totalSec = min * 60;
            sendCmd(`SET:${totalSec}`); 
            sendCmd("CLR"); 
        }
        function setCustom() {
            const m = parseInt(document.getElementById('cust-min').value) || 0;
            const s = parseInt(document.getElementById('cust-sec').value) || 0;
            totalSec = (m*60) + s;
            sendCmd(`SET:${totalSec}`);
            sendCmd("CLR");
        }

        function sendMessage() {
            const txt = document.getElementById('msg-text').value;
            const dur = document.getElementById('msg-dur').value;
            const fs = document.getElementById('chk-fs').checked ? "1" : "0";
            const fl = document.getElementById('chk-fl').checked ? "1" : "0";
            // Send Color ID if FS checked
            let col = -1;
            if(document.getElementById('chk-fs').checked) col = selectedMsgColor;
            sendCmd(`MSG:${txt}|${dur}|${fs}|${fl}|${col}`);
        }

        // brightness controls removed

        function reconnectBLE() {
            if (bluetoothDevice && bluetoothDevice.gatt && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            connectBLE();
        }

        // Direct Draw control removed from web UI

        // touch controls removed

        function syncCfg() {
            const at = document.getElementById('def-amber-t').value * 60;
            const rt = document.getElementById('def-red-t').value * 60;
            const am = document.getElementById('def-amber-msg').value;
            const rm = document.getElementById('def-red-msg').value;
            sendCmd(`CFG:${at},${rt}|${am}|${rm}`);
        }

        function checkAutoAlerts(currentMsgOnScreen) {
            // Logic moved to ESP32 for standalone operation
        }
    </script>
</body>
</html>