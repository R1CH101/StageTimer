<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ESP32 Controller</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #fff; --accent: #3b82f6; --danger: #ef4444; --warn: #eab308; --success: #22c55e; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* HEADER & STATUS */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--panel); padding: 15px; border-radius: 12px; }
        #status-dot { height: 12px; width: 12px; background: var(--danger); border-radius: 50%; display: inline-block; }
        .connected #status-dot { background: var(--success); box-shadow: 0 0 10px var(--success); }

        /* PREVIEW SCREEN */
        #preview-box {
            background: #000; border: 4px solid #333; height: 120px; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: background 0.3s;
        }
        #p-timer { font-size: 3rem; font-weight: bold; line-height: 1; }
        #p-msg { font-size: 1rem; margin-top: 5px; color: #aaa; }

        /* CONTROLS */
        .panel { background: var(--panel); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; }
        label { font-size: 0.85rem; text-transform: uppercase; color: #888; font-weight: bold; }
        
        /* BUTTONS & INPUTS */
        .btn-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn-act-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        
        button { border: none; padding: 12px; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer; background: #333; color: white; transition: 0.2s; }
        button:active { transform: scale(0.96); }
        .btn-blue { background: var(--accent); }
        .btn-green { background: var(--success); color: black; }
        .btn-red { background: var(--danger); }
        .btn-warn { background: var(--warn); color: black; }
        
        input { background: #2a2a2a; border: 1px solid #444; padding: 10px; color: white; border-radius: 6px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        
        /* TOGGLES */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 5px; }
        input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--accent); }

    </style>
</head>
<body>

    <div class="header" id="header">
        <h2 style="margin:0">Stage Timer</h2>
        <div>
            <span id="status-text">Disconnected</span>
            <div id="status-dot"></div>
        </div>
    </div>
    <button class="btn-blue" id="btn-connect" style="width:100%">CONNECT TO SCREEN</button>

    <div id="preview-box">
        <div id="p-timer">--:--</div>
        <div id="p-msg"></div>
    </div>

    <div class="panel">
        <label>Presets (Min)</label>
        <div class="btn-row">
            <button onclick="setTimer(5)">5</button>
            <button onclick="setTimer(10)">10</button>
            <button onclick="setTimer(15)">15</button>
            <button onclick="setTimer(20)">20</button>
        </div>
        
        <label style="margin-top:10px">Manual Set (Min)</label>
        <div style="display:flex; gap:10px">
            <input type="number" id="inp-min" value="5" placeholder="Min">
            <button class="btn-blue" onclick="sendCustomTime()" style="width:auto">SET</button>
        </div>

        <div class="btn-act-row">
            <button class="btn-green" onclick="sendCmd('START')">START</button>
            <button class="btn-red" onclick="sendCmd('STOP')">STOP</button>
            <button class="btn-warn" onclick="sendCmd('RESET')">RESET</button>
        </div>
    </div>

    <div class="panel">
        <label>Alert Thresholds (Min)</label>
        <div style="display:flex; gap:10px">
            <input type="number" id="cfg-amber" value="2" placeholder="Amber">
            <input type="number" id="cfg-red" value="0" placeholder="Red">
            <button class="btn-blue" onclick="sendConfig()">CFG</button>
        </div>
    </div>

    <div class="panel">
        <label>Message Center</label>
        <input type="text" id="inp-msg" placeholder="Enter message...">
        
        <div class="toggle-row">
            <span>Full Screen Mode</span>
            <input type="checkbox" id="chk-fs" onchange="toggleFS()">
        </div>
        <div class="toggle-row">
            <span>Flash Screen</span>
            <input type="checkbox" id="chk-fl" onchange="toggleFlash()">
        </div>

        <div class="btn-act-row">
            <button class="btn-blue" style="grid-column:span 2" onclick="sendMessage()">SEND TEXT</button>
            <button class="btn-red" onclick="sendCmd('CLR')">CLEAR</button>
        </div>
    </div>

    <script>
        // UUIDs MUST MATCH ESP32
        const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const CHAR_UUID = "0000ffe1-0000-1000-8000-00805f9b34fb";

        let device, server, service, characteristic;

        const btnConnect = document.getElementById('btn-connect');
        const header = document.getElementById('header');
        const pTimer = document.getElementById('p-timer');

        btnConnect.addEventListener('click', connectBLE);

        async function connectBLE() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }] // Look for FFE0
                });

                btnConnect.innerText = "Connecting...";
                
                device.addEventListener('gattserverdisconnected', onDisconnect);

                server = await device.gatt.connect();
                service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHAR_UUID);

                // Start Notifications (Listen to ESP32)
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleNotify);

                // UI Updates
                header.classList.add('connected');
                document.getElementById('status-text').innerText = "Connected";
                btnConnect.style.display = 'none';

                // Send Initial Config
                sendConfig();

            } catch (error) {
                console.error(error);
                alert("Connection Failed: " + error);
                btnConnect.innerText = "CONNECT TO SCREEN";
            }
        }

        function onDisconnect() {
            header.classList.remove('connected');
            document.getElementById('status-text').innerText = "Disconnected";
            btnConnect.style.display = 'block';
            btnConnect.innerText = "CONNECT TO SCREEN";
            pTimer.innerText = "--:--";
        }

        // --- SENDING COMMANDS ---
        
        async function sendCmd(cmd) {
            if (!characteristic) return;
            const encoder = new TextEncoder();
            await characteristic.writeValue(encoder.encode(cmd));
        }

        function setTimer(min) {
            const sec = min * 60;
            sendCmd(`SET:${sec}`);
        }

        function sendCustomTime() {
            const min = parseInt(document.getElementById('inp-min').value) || 0;
            setTimer(min);
        }

        function sendConfig() {
            const amber = parseInt(document.getElementById('cfg-amber').value) || 2;
            const red = parseInt(document.getElementById('cfg-red').value) || 0;
            // Convert mins to seconds for internal logic if needed, 
            // but ESP32 code expects mins for thresholds based on your prompt logic?
            // Actually, your C++ uses raw seconds in loop but ints for variables.
            // Let's send SECONDS to be safe with the ESP32 logic:
            sendCmd(`CFG:${amber*60},${red*60}`);
        }

        function sendMessage() {
            const msg = document.getElementById('inp-msg').value;
            sendCmd(`MSG:${msg}`);
        }

        function toggleFS() {
            const isChecked = document.getElementById('chk-fs').checked;
            sendCmd(isChecked ? "FS:ON" : "FS:OFF");
        }

        function toggleFlash() {
            const isChecked = document.getElementById('chk-fl').checked;
            sendCmd(isChecked ? "FL:ON" : "FL:OFF");
        }

        // --- RECEIVING DATA ---

        function handleNotify(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const data = decoder.decode(value);
            
            // Expected format: "TIME:05:00"
            if (data.startsWith("TIME:")) {
                pTimer.innerText = data.substring(5);
            }
        }

    </script>
</body>
</html>
