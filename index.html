<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Timer Control</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #fff; --accent: #3b82f6; --danger: #ef4444; --warn: #eab308; --success: #22c55e; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x:hidden;}
        
        /* HEADER */
        .header { padding: 15px; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .status-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #333; color: #aaa; }
        .connected .status-badge { background: var(--success); color: #000; }

        /* LIVE PREVIEW - EXACT REPLICA */
        #preview-container { 
            width: 100%; height: 160px; background: #000; 
            display: flex; align-items: center; justify-content: center;
            border-bottom: 4px solid #333; transition: all 0.2s;
            position: relative;
        }
        #p-time { font-size: 4rem; font-weight: 800; line-height: 1; z-index: 2; transition: color 0.2s;}
        #p-msg { font-size: 1.2rem; margin-top: 10px; position: absolute; bottom: 10px; width: 100%; text-align: center; font-weight: bold; }

        /* MAIN CONTROLS */
        .scroll-area { padding: 15px; padding-bottom: 100px; }
        .panel { background: var(--panel); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        h3 { margin: 0 0 10px 0; font-size: 0.9rem; text-transform: uppercase; color: #888; }

        /* GRID BUTTONS */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        
        button { border: none; padding: 15px 5px; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; background: #333; color: white; transition: transform 0.1s; }
        button:active { transform: scale(0.96); }
        .btn-green { background: var(--success); color: #000; }
        .btn-red { background: var(--danger); }
        .btn-blue { background: var(--accent); }
        .btn-warn { background: var(--warn); color: #000; }
        .btn-outline { background: transparent; border: 1px solid #555; }

        input { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 10px; box-sizing: border-box;}
        
        /* SETTINGS DRAWER */
        .settings-drawer { display: none; background: #181818; padding: 15px; border-left: 2px solid var(--accent); margin-bottom: 15px; }
        .open { display: block; }

        /* MESSAGE OPTIONS */
        .msg-opts { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; font-size: 0.9rem;}
        input[type="checkbox"] { width: 20px; height: 20px; }
        input[type="range"] { flex: 1; }

    </style>
</head>
<body>

    <div class="header" id="header">
        <h2 style="margin:0">Stage Timer</h2>
        <div class="status-badge" id="status">Disconnected</div>
    </div>
    <button id="btn-conn" class="btn-blue" style="width:100%; border-radius:0;" onclick="connectBLE()">TAP TO CONNECT SCREEN</button>

    <div id="preview-container">
        <div id="p-time">00:00</div>
        <div id="p-msg"></div>
    </div>

    <div class="scroll-area">
        
        <div class="panel">
            <h3>Quick Start</h3>
            <div class="grid-4" style="margin-bottom:10px;">
                <button onclick="setPreset(5)">5m</button>
                <button onclick="setPreset(10)">10m</button>
                <button onclick="setPreset(15)">15m</button>
                <button onclick="setPreset(20)">20m</button>
            </div>
            <div class="grid-3">
                <button class="btn-green" onclick="sendCmd('START')">START</button>
                <button class="btn-red" onclick="sendCmd('STOP')">STOP</button>
                <button class="btn-warn" onclick="sendCmd('RESET')">RESET</button>
            </div>
            <div style="margin-top:10px; text-align: right;">
                <small onclick="toggleSettings()" style="color: var(--accent); cursor: pointer;">+ Configure Defaults & Text</small>
            </div>
        </div>

        <div id="settings-box" class="settings-drawer panel">
            <h3>Timer Defaults</h3>
            <label>Amber Warning (Minutes)</label>
            <input type="number" id="def-amber-time" value="2" onchange="saveDefaults()">
            <label>Amber Text (Auto-send)</label>
            <input type="text" id="def-amber-text" value="Prepare to Finish" onchange="saveDefaults()">
            
            <label>Red Warning (Minutes)</label>
            <input type="number" id="def-red-time" value="0" onchange="saveDefaults()">
            <label>Red Text (Auto-send)</label>
            <input type="text" id="def-red-text" value="Please Close!" onchange="saveDefaults()">
        </div>

        <div class="panel">
            <h3>Send Message</h3>
            <input type="text" id="msg-input" placeholder="Type message here...">
            
            <div class="msg-opts">
                <input type="checkbox" id="chk-fullscreen"> <label>Full Screen</label>
                <input type="checkbox" id="chk-flash"> <label>Flash (3x)</label>
            </div>
            <div class="msg-opts" id="dur-box">
                <label>Hide in (sec): </label>
                <input type="number" id="msg-dur" value="10" style="width:60px">
                <small>(0 = Forever)</small>
            </div>

            <div class="grid-3">
                <button class="btn-blue" style="grid-column: span 2" onclick="triggerMessage()">SEND MSG</button>
                <button class="btn-outline" onclick="sendCmd('CLR')">CLEAR</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const CHAR_UUID = "0000ffe1-0000-1000-8000-00805f9b34fb";
        
        let characteristic;
        let autoMsgTriggered = { amber: false, red: false };
        let currentTimerSec = 0;
        let isRunning = false;

        // Load Defaults
        window.onload = () => {
            if(localStorage.getItem('defAmberT')) document.getElementById('def-amber-time').value = localStorage.getItem('defAmberT');
            if(localStorage.getItem('defAmberTxt')) document.getElementById('def-amber-text').value = localStorage.getItem('defAmberTxt');
            if(localStorage.getItem('defRedT')) document.getElementById('def-red-time').value = localStorage.getItem('defRedT');
            if(localStorage.getItem('defRedTxt')) document.getElementById('def-red-text').value = localStorage.getItem('defRedTxt');
        }

        function saveDefaults() {
            localStorage.setItem('defAmberT', document.getElementById('def-amber-time').value);
            localStorage.setItem('defAmberTxt', document.getElementById('def-amber-text').value);
            localStorage.setItem('defRedT', document.getElementById('def-red-time').value);
            localStorage.setItem('defRedTxt', document.getElementById('def-red-text').value);
        }

        function toggleSettings() {
            document.getElementById('settings-box').classList.toggle('open');
        }

        // --- BLUETOOTH ---
        async function connectBLE() {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHAR_UUID);
                
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleNotify);
                
                document.getElementById('header').classList.add('connected');
                document.getElementById('status').innerText = "Connected";
                document.getElementById('btn-conn').style.display = 'none';

                // Sync Config to ESP32
                syncConfig();

            } catch (e) { alert("Connect Error: " + e); }
        }

        function handleNotify(e) {
            const dec = new TextDecoder();
            const raw = dec.decode(e.target.value); 
            // Expected: "05:00|#00FF00|#000000|Msg"
            
            const parts = raw.split('|');
            if(parts.length >= 3) {
                const timeStr = parts[0];
                const bgHex = parts[1];
                const txtHex = parts[2];
                const msg = parts[3] || "";

                // Update Preview
                const box = document.getElementById('preview-container');
                const tEl = document.getElementById('p-time');
                const mEl = document.getElementById('p-msg');

                box.style.backgroundColor = bgHex;
                tEl.style.color = txtHex;
                tEl.innerText = timeStr;
                
                mEl.style.color = txtHex;
                mEl.innerText = msg;

                // Parse Time for Logic
                const [m, s] = timeStr.split(':').map(Number);
                currentTimerSec = (m * 60) + s;
                
                checkAutoTriggers();
            }
        }

        async function sendCmd(cmd) {
            if(!characteristic) return;
            const enc = new TextEncoder();
            await characteristic.writeValue(enc.encode(cmd));
            
            if(cmd === "RESET" || cmd.startsWith("SET")) {
                autoMsgTriggered = { amber: false, red: false };
                isRunning = false;
            }
            if(cmd === "START") isRunning = true;
        }

        // --- LOGIC ---

        function setPreset(min) {
            const sec = min * 60;
            sendCmd(`SET:${sec}`);
            syncConfig(); // Ensure defaults are synced
            // Clear message
            sendCmd("CLR");
        }

        function syncConfig() {
            const amber = document.getElementById('def-amber-time').value * 60;
            const red = document.getElementById('def-red-time').value * 60;
            sendCmd(`CFG:${amber},${red}`);
        }

        function checkAutoTriggers() {
            if(!isRunning) return;

            const amberSec = document.getElementById('def-amber-time').value * 60;
            const redSec = document.getElementById('def-red-time').value * 60;
            const amberTxt = document.getElementById('def-amber-text').value;
            const redTxt = document.getElementById('def-red-text').value;

            // Trigger Amber Text
            if(currentTimerSec <= amberSec && currentTimerSec > redSec && !autoMsgTriggered.amber) {
                if(amberTxt) sendCmd(`MSG:${amberTxt}`);
                autoMsgTriggered.amber = true;
            }

            // Trigger Red Text
            if(currentTimerSec <= redSec && !autoMsgTriggered.red) {
                if(redTxt) sendCmd(`MSG:${redTxt}`);
                autoMsgTriggered.red = true;
            }
        }

        function triggerMessage() {
            const text = document.getElementById('msg-input').value;
            const fs = document.getElementById('chk-fullscreen').checked;
            const flash = document.getElementById('chk-flash').checked;
            const dur = document.getElementById('msg-dur').value * 1000;

            if(flash) sendCmd("FL:3"); // Trigger Flash First

            // Send Message
            if(fs) sendCmd(`FSMSG:${text}`);
            else sendCmd(`MSG:${text}`);

            // Auto Clear Logic
            if(dur > 0) {
                setTimeout(() => {
                    sendCmd("CLR");
                }, dur);
            }
        }

    </script>
</body>
</html>
