<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Timer</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #fff; --accent: #3b82f6; --danger: #ef4444; --warn: #eab308; --success: #22c55e; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 50px;}
        
        #preview-container { 
            width: 100%; height: 180px; background: #000; 
            display: flex; flex-direction:column; align-items: center; justify-content: center;
            border-bottom: 4px solid #333; position: sticky; top:0; z-index:10;
        }
        #p-time { font-size: 4.5rem; font-weight: 800; line-height: 1; margin:0; transition: color 0.3s;}
        #p-msg { font-size: 1.2rem; margin-top: 5px; text-align: center; height: 1.5em; overflow:hidden;}
        
        .status-bar { font-size: 0.8rem; color: #666; width:100%; text-align:center; background:#111; padding:5px 0;}
        .status-bar.off { color: var(--danger); font-weight: bold; background: #300; }

        .container { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .panel { background: var(--panel); border-radius: 12px; padding: 15px; }
        h3 { margin: 0 0 10px 0; color: #888; font-size: 0.9rem; text-transform: uppercase; }

        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        
        button { border: none; padding: 15px 5px; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; background: #333; color: white; width:100%; }
        button:active { transform: scale(0.95); }
        .btn-green { background: var(--success); color: #000; }
        .btn-red { background: var(--danger); }
        .btn-warn { background: var(--warn); color: #000; }
        .btn-blue { background: var(--accent); }

        input { background: #2a2a2a; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;}
        input[type="checkbox"] { width: 24px; height: 24px; }
        
        .mode-toggle { display:flex; justify-content:center; gap:20px; background:#000; padding:10px; border-radius:8px; margin-bottom:15px; }
        .mode-opt { color:#666; font-weight:bold; cursor:pointer; }
        .mode-opt.active { color:var(--accent); text-decoration: underline; }

        /* Color Picker */
        .color-row { display:flex; gap:5px; margin-top:10px; }
        .c-btn { flex:1; height:40px; border-radius:6px; border:2px solid #333; cursor:pointer; opacity:0.6; }
        .c-btn.selected { border-color:white; opacity:1; box-shadow:0 0 5px white; }
        .bg-auto { background: #333; text-align:center; line-height:36px; font-size:0.8rem; color:#aaa; }
        .bg-grn { background: var(--success); }
        .bg-amb { background: var(--warn); }
        .bg-red { background: var(--danger); }
        .bg-blk { background: #000; }

    </style>
</head>
<body>

    <div id="preview-container">
        <div id="p-time">--:--</div>
        <div id="p-msg"></div>
    </div>
    <div class="status-bar" id="status">Tap Connect below</div>
    <button onclick="connectBLE()" id="btn-conn" class="btn-blue" style="border-radius:0">CONNECT</button>

    <div class="container">
        <div class="mode-toggle">
            <div id="mode-dn" class="mode-opt active" onclick="setMode(0)">COUNT DOWN</div>
            <div id="mode-up" class="mode-opt" onclick="setMode(1)">COUNT UP</div>
        </div>

        <div class="panel">
            <h3>Set Time (Target)</h3>
            <div class="row">
                <div style="flex:1"><label>Min</label><input type="number" id="cust-min" value="0"></div>
                <div style="flex:1"><label>Sec</label><input type="number" id="cust-sec" value="0"></div>
                <button class="btn-blue" style="flex:1; align-self:flex-end" onclick="setCustom()">SET</button>
            </div>
            <div class="grid-4" style="margin-top:10px">
                <button onclick="setPreset(5)">5m</button>
                <button onclick="setPreset(10)">10m</button>
                <button onclick="setPreset(15)">15m</button>
                <button onclick="setPreset(20)">20m</button>
            </div>
            <div class="row" style="margin-top:15px">
                <button class="btn-green" onclick="sendCmd('START'); syncCfg();">START</button>
                <button class="btn-red" onclick="sendCmd('STOP')">STOP</button>
                <button class="btn-warn" onclick="sendCmd('RESET')">RESET</button>
            </div>
        </div>

        <div class="panel">
            <h3>Message Center</h3>
            <input type="text" id="msg-text" maxlength="120" placeholder="Enter message (Max 120)" style="font-size:1.1rem; margin-bottom:15px">
            
            <div class="color-row">
                <div class="c-btn bg-auto selected" onclick="setMsgColor(-1, this)">Auto</div>
                <div class="c-btn bg-grn" onclick="setMsgColor(0, this)"></div>
                <div class="c-btn bg-amb" onclick="setMsgColor(1, this)"></div>
                <div class="c-btn bg-red" onclick="setMsgColor(2, this)"></div>
                <div class="c-btn bg-blk" onclick="setMsgColor(3, this)"></div>
            </div>

            <div class="toggle-row" style="margin-top:15px;">
                <span>Show Duration (Sec)</span>
                <input type="number" id="msg-dur" value="30" style="width:60px; text-align:center">
            </div>
            <div class="toggle-row">
                <span>Full Screen</span>
                <input type="checkbox" id="chk-fs">
            </div>
            <div class="toggle-row">
                <span>Flash</span>
                <input type="checkbox" id="chk-fl">
            </div>

            <div class="row" style="margin-top:10px">
                <button class="btn-blue" onclick="sendMessage()">SEND</button>
                <button style="background:#444" onclick="sendCmd('CLR')">CLEAR</button>
            </div>
        </div>

        <div class="panel">
            <h3>Auto-Alert Defaults</h3>
            <div class="row">
                <div style="flex:1">
                    <label style="color:var(--warn)">Amber Min</label>
                    <input type="number" id="def-amber-t" value="2" onchange="saveDef()">
                </div>
                <div style="flex:2">
                    <label>Amber Text</label>
                    <input type="text" id="def-amber-msg" value="Prepare to finish" onchange="saveDef()">
                </div>
            </div>
            <div class="row">
                <div style="flex:1">
                    <label style="color:var(--danger)">Red Min</label>
                    <input type="number" id="def-red-t" value="0" onchange="saveDef()">
                </div>
                <div style="flex:2">
                    <label>Red Text</label>
                    <input type="text" id="def-red-msg" value="Please Close!" onchange="saveDef()">
                </div>
            </div>
        </div>
    </div>

    <script>
        const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const CHAR_UUID = "0000ffe1-0000-1000-8000-00805f9b34fb";
        let bluetoothDevice;
        let char;
        
        let currentSec = 0;
        let isRunning = false;
        let amberTriggered = false;
        let redTriggered = false;
        let isCountUp = 0;
        let selectedMsgColor = -1;

        function setMode(m) {
            isCountUp = m;
            document.getElementById('mode-dn').className = m === 0 ? "mode-opt active" : "mode-opt";
            document.getElementById('mode-up').className = m === 1 ? "mode-opt active" : "mode-opt";
        }

        function setMsgColor(c, el) {
            selectedMsgColor = c;
            document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        if(localStorage.getItem('cfg')) {
            const c = JSON.parse(localStorage.getItem('cfg'));
            document.getElementById('def-amber-t').value = c.at;
            document.getElementById('def-amber-msg').value = c.am;
            document.getElementById('def-red-t').value = c.rt;
            document.getElementById('def-red-msg').value = c.rm;
        }

        function saveDef() {
            const cfg = {
                at: document.getElementById('def-amber-t').value,
                am: document.getElementById('def-amber-msg').value,
                rt: document.getElementById('def-red-t').value,
                rm: document.getElementById('def-red-msg').value
            };
            localStorage.setItem('cfg', JSON.stringify(cfg));
            syncCfg();
        }

        async function connectBLE() {
            try {
                bluetoothDevice = await navigator.bluetooth.requestDevice({ 
                    filters: [{ services: [SERVICE_UUID] }] 
                });
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnect);
                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                char = await service.getCharacteristic(CHAR_UUID);
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', onData);
                
                document.getElementById('status').innerText = "Connected";
                document.getElementById('status').classList.remove('off');
                document.getElementById('status').style.color = "#22c55e";
                document.getElementById('btn-conn').style.display = 'none';
                syncCfg();

            } catch(e) { alert("Connection failed: " + e); }
        }

        function onDisconnect() {
            document.getElementById('status').innerText = "DISCONNECTED";
            document.getElementById('status').classList.add('off');
            document.getElementById('btn-conn').style.display = 'block';
            document.getElementById('preview-container').style.background = "#000";
            document.getElementById('p-time').innerText = "--:--";
            char = null;
        }

        function onData(e) {
            const dec = new TextDecoder();
            const raw = dec.decode(e.target.value); 
            const p = raw.split('|');
            // Packet: TIME|BG|TXT|MSG|IS_FS
            if(p.length >= 5) {
                document.getElementById('preview-container').style.background = p[1];
                
                const timeEl = document.getElementById('p-time');
                const msgEl = document.getElementById('p-msg');
                const isFs = (p[4] === "1");

                if (isFs) {
                    timeEl.style.display = 'none';
                    msgEl.style.fontSize = "1.5rem";
                    msgEl.style.fontWeight = "bold";
                    msgEl.style.height = "auto";
                } else {
                    timeEl.style.display = 'block';
                    timeEl.style.color = p[2];
                    timeEl.innerText = p[0];
                    msgEl.style.fontSize = "1.2rem";
                    msgEl.style.fontWeight = "normal";
                    msgEl.style.height = "1.5em";
                }

                msgEl.style.color = p[2];
                msgEl.innerText = p[3] || "";
                
                let timeParts = p[0].replace('-','').split(':');
                if(timeParts.length === 2) {
                    let sec = (parseInt(timeParts[0])*60) + parseInt(timeParts[1]);
                    if(p[0].includes('-')) sec = -sec;
                    currentSec = sec;
                    checkAutoAlerts(p[3]); 
                }
            }
        }

        async function sendCmd(c) {
            if(!char) return;
            try {
                const enc = new TextEncoder().encode(c);
                await char.writeValue(enc);
                if(c === "RESET" || c.startsWith("SET")) {
                    amberTriggered = false; redTriggered = false; isRunning = false;
                }
                if(c === "START") isRunning = true;
            } catch(e) { console.log("Send Error"); }
        }

        function setPreset(min) { sendCmd(`SET:${min*60}|${isCountUp}`); sendCmd("CLR"); }
        function setCustom() {
            const m = parseInt(document.getElementById('cust-min').value) || 0;
            const s = parseInt(document.getElementById('cust-sec').value) || 0;
            sendCmd(`SET:${(m*60)+s}|${isCountUp}`);
            sendCmd("CLR");
        }

        function sendMessage() {
            const txt = document.getElementById('msg-text').value;
            const dur = document.getElementById('msg-dur').value;
            const fs = document.getElementById('chk-fs').checked ? "1" : "0";
            const fl = document.getElementById('chk-fl').checked ? "1" : "0";
            // ADDED: Color Param
            sendCmd(`MSG:${txt}|${dur}|${fs}|${fl}|${selectedMsgColor}`);
        }

        function syncCfg() {
            const at = document.getElementById('def-amber-t').value * 60;
            const rt = document.getElementById('def-red-t').value * 60;
            sendCmd(`CFG:${at},${rt}`);
        }

        function checkAutoAlerts(currentMsgOnScreen) {
            if(!isRunning) return;
            
            const at = document.getElementById('def-amber-t').value * 60;
            const rt = document.getElementById('def-red-t').value * 60;
            
            if(currentSec <= at && currentSec > rt && !amberTriggered) {
                const msg = document.getElementById('def-amber-msg').value;
                if(msg) sendCmd(`MSG:${msg}|0|0|0|-1`);
                amberTriggered = true;
            }
            if(currentSec <= rt && !redTriggered) {
                const msg = document.getElementById('def-red-msg').value;
                if(msg) sendCmd(`MSG:${msg}|0|0|0|-1`);
                redTriggered = true;
            }
        }
    </script>
</body>
</html>
